@model IEnumerable<Todo>

<div class="row">
    @if (ViewBag.IsLoggedIn ?? false)
    {
        <div class="col-md-4">
            <div class="card mb-3" style="border-radius: 2.5rem 2.5rem 2.5rem 2.5rem;">
                <div class="card-header fw-bold text-center" style="font-size:2.5em; 
                background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); box-shadow: 0 4px 16px rgba(0,0,0,0.08); 
                border-radius: 2.5rem 2.5rem 0 0; color: white; font-size:2.5em;">Filter</div>
                <div style="height:0.5rem;"></div>
                <div class="card-body">
                    <form asp-action="Filter" method="post" style="background-color: #a1e7f2; border-radius: 2.5rem; padding: 1.5rem; width: 100%;">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label" style="font-size:1.3em; font-weight:bold;">Category</label>
                                <select name="filter" class="form-select"
                                    asp-items="@(new SelectList(ViewBag.Categories,"categoryId","categoryName",ViewBag.Filters.categoryID))">
                                    @if (ViewBag.Filters.categoryID == null || ViewBag.Filters.categoryID == "all") {
                                        <option value="all" selected>All</option>
                                    } else {
                                        <option value="all">All</option>
                                    }
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label" style="font-size:1.3em; font-weight:bold;">Due Date</label>
                                <select name="filter" class="form-select"
                                    asp-items="@(new SelectList(ViewBag.DueFilters, "Key", "Value", ViewBag.Filters.dueDate))">
                                    @if (ViewBag.Filters.dueDate == null || ViewBag.Filters.dueDate == "all") {
                                        <option value="all" selected>All</option>
                                    } else {
                                        <option value="all">All</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label" style="font-size:1.3em; font-weight:bold;">Status</label>
                                <select name="filter" class="form-select"
                                    asp-items="@(new SelectList(ViewBag.Statuses, "statusId", "statusName", ViewBag.Filters.statusID))">
                                    @if (ViewBag.Filters.statusID == null || ViewBag.Filters.statusID == "all") {
                                        <option value="all" selected>All</option>
                                    } else {
                                        <option value="all">All</option>
                                    }
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label" style="font-size:1.3em; font-weight:bold;">Due In</label>
                                <select name="filter" class="form-select">
                                    @if (ViewBag.Filters.dueIn == null || ViewBag.Filters.dueIn == "all") {
                                        <option value="all" selected>All</option>
                                    } else {
                                        <option value="all">All</option>
                                    }
                                    @if (ViewBag.Filters.dueIn == "5") {
                                        <option value="5" selected>5 Days</option>
                                    } else {
                                        <option value="5">5 Days</option>
                                    }
                                    @if (ViewBag.Filters.dueIn == "15") {
                                        <option value="15" selected>15 Days</option>
                                    } else {
                                        <option value="15">15 Days</option>
                                    }
                                    @if (ViewBag.Filters.dueIn == "30") {
                                        <option value="30" selected>30 Days</option>
                                    } else {
                                        <option value="30">30 Days</option>
                                    }
                                    @if (ViewBag.Filters.dueIn == "90") {
                                        <option value="90" selected>90 Days</option>
                                    } else {
                                        <option value="90">90 Days</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="font-size:1.2em; font-weight:bold; padding:0.6em 1.2em;">Filter</button>
                        <a asp-action="Index" asp-route-id="" class="btn btn-warning" style="font-size:1.2em; font-weight:bold; padding:0.6em 1.2em;">Clear</a>
                    </form>
                </div>
            </div>
        </div>
    }
    @if (!(ViewBag.IsLoggedIn ?? false))
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card mb-3" style="border-radius: 2.5rem;">
                    <div class="card-header fw-bold text-center" style="font-size:2.5em; background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); box-shadow: 0 4px 16px rgba(0,0,0,0.08); border-radius: 2.5rem 2.5rem 0 0; color: white;">User Management</div>
                    <div style="height:0.5rem;"></div>
                    <div class="card-body">
                        <form asp-action="LogIn" method="post" style="background-image: url(https://t3.ftcdn.net/jpg/02/94/52/66/360_F_294526635_8Fc9IbBHWOC83JsiFNRNx5VivafEjiyi.jpg); background-repeat: no-repeat; background-size: cover; padding: 1px; border: 2px solid black; max-width: 500px; margin: 20px auto; box-sizing: border-box; border-radius: 20px;">
                            <h2 align="center">Login</h2>
                            <p style="color: rgb(7, 7, 26);" align="center">Please fill out the form:</p>
                            <div align="center">
                                <div style="display: inline-block; background-color: lightseagreen; padding: 10px; border-radius: 20px;">
                                    <label for="mail">Mail:</label>
                                    <input type="email" id="mail" name="mail" placeholder="ex@gmail.com" required>
                                    <br><br>
                                    <label for="password">Password:</label>
                                    <input type="password" id="password" name="password" placeholder="************" required>
                                    <br><br>
                                    <button type="submit">Login</button>
                                    <a asp-action="SignIn" class="btn btn-success" style="margin-left:10px;">Sign Up</a>
                                    <br><br>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
    @if (ViewBag.IsLoggedIn ?? false)
    {
        <div class="col-md-8"> 
            <div class="card mb-3" style="border-radius: 2.5rem 2.5rem 2.5rem 2.5rem;">
                <div class="card-header fw-bold text-center" style="font-size:2.5em; 
                background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); box-shadow: 0 4px 16px rgba(0,0,0,0.08); 
                border-radius: 2.5rem 2.5rem 0 0; color: white; font-size:2.5em;">User Management</div>
                <div style="height:0.5rem;"></div>
                <div class="card-body">
                    <div style="background: #e0f7fa; border-radius: 20px; padding: 1.5em; text-align:center;">
                        <h3>Welcome, <b>@ViewBag.UserName</b>!</h3>
                        <p>Role: <b>@ViewBag.UserRole</b></p>
                        @if (!string.IsNullOrEmpty((string)ViewBag.TeamName))
                        {
                            <p>Team: <b>@ViewBag.TeamName</b></p>
                        }
                        @if ((string)ViewBag.UserRole == "Team Leader" && !string.IsNullOrEmpty((string)ViewBag.TeamInvitationCode))
                        {
                            <p>Invitation Code: <b>@ViewBag.TeamInvitationCode</b></p>
                        }
                        <form asp-action="LogOut" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger" style="font-size:1.5em;">Logout</button>
                        </form>
                    </div>
                    @if ((ViewBag.UserRole as string) == "Team Member" && string.IsNullOrEmpty((string)ViewBag.TeamName))
                    {
                        <button class="btn btn-warning" style="font-size:1.2em; margin-top:1em;" data-bs-toggle="modal" data-bs-target="#joinTeamModal">Join Team</button>
                        <!-- Modal -->
                        <div class="modal fade" id="joinTeamModal" tabindex="-1" aria-labelledby="joinTeamModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="joinTeamModalLabel">Join a Team</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <form asp-action="JoinTeam" method="post">
                                <div class="modal-body">
                                  <label for="joinInvitationCode">Team Invitation Code:</label>
                                  <input type="text" id="joinInvitationCode" name="invitationCode" maxlength="5" class="form-control" required>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                  <button type="submit" class="btn btn-primary">Join</button>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                    }
                </div>
            </div>
            @if (ViewBag.IsLoggedIn ?? false)
            {
                <div class="card mb-3" style="border-radius: 2.5rem 2.5rem 2.5rem 2.5rem;">
                    <div class="card-header fw-bold text-center" style="font-size:2.5em; 
                    background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); box-shadow: 0 4px 16px rgba(0,0,0,0.08); 
                    border-radius: 2.5rem 2.5rem 0 0; color: white; font-size:2.5em;">Task Management</div>
                    <div style="height:0.5rem;"></div>
                    <div class="card-body">
                        <form asp-action="DeleteComplete" method="post" asp-route-id="@ViewBag.Filters.FilterString" class="d-inline w-100">
                            <a asp-action="Add" class="btn btn-primary" style="font-size:1.5em;">Add a New Task</a>
                            <button type="submit" class="btn btn-danger" style="font-size:1.5em;">Delete All Completed Tasks</button>
                            <a class="btn btn-success float-end" href="https://calendar.google.com/calendar/u/0/r?pli=1" style="font-size:1.5em;"
                            target="=_blank">Set a Reminder</a> 
                            <br><br>
                        </form>
                    </div>
                </div>
                <div class="card" style="border-radius: 2.5rem 2.5rem 2.5rem 2.5rem;">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center text-center" style="font-size:2em; 
                    background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); box-shadow: 0 4px 16px rgba(0,0,0,0.08); 
                    border-radius: 2.5rem 2.5rem 0 0; color: white; font-size:2.5em;">
                        <div class="d-flex align-items-center" style="gap: 0.5em;">
                            <span>
                                <span class="badge bg-success" style="width:1.0em; height:1.0em; display:inline-block; border-radius:50%;"></span>
                                <span style="font-size:0.5em;">Completed</span>
                            </span>
                            <span>
                                <span class="badge bg-warning" style="width:1.0em; height:1.0em; display:inline-block; border-radius:50%;"></span>
                                <span style="font-size:0.5em;">Pending</span>
                            </span>
                            <span>
                                <span class="badge bg-danger" style="width:1.0em; height:1.0em; display:inline-block; border-radius:50%;"></span>
                                <span style="font-size:0.5em;">Overdue</span>
                            </span>
                            <span class="ms-5">
                                <span class="ms-5"></span>
                                <span class="ms-3"></span>
                            <i class="bi bi-list-task"></i> Tasks</span>
                        </div>
                        <div style="font-size:1em; margin-left: 1.5em;">
                            
                        </div>
                        <span style="font-size:0.7em;">
                            <span style="background: #28a745; color: white; border-radius: 1.5em; padding: 0.4em 0.4em; font-weight: bold; font-size:0.7em; display: inline-block; min-width: 20px; text-align: center;">
                                @ViewBag.CompletedCount/@ViewBag.TotalCount
                            </span>
                        </span>
                    </div>
                    <div style="height:0.5rem;"></div>
                    <div class="card-body">
                        <form asp-action="MarkComplete" method="post" asp-route-id="@ViewBag.Filters.FilterString">
                            <table class="table table-bordered table-striped mt-2 rounded-3 overflow-hidden"> 
                                <thead> 
                                    <tr>
                                        <th class="fw-bold text-center align-middle" style="font-size:1.6em; vertical-align: middle;">
                                            <div class="d-flex flex-row align-items-center justify-content-center" style="gap:6px;">
                                                <span>Name</span>
                                                <a href="?sort=name_asc" class="btn btn-light btn-sm rounded-circle p-0 ms-1" style="width:1.5em; height:1.5em;" title="Sort A-Z">
                                                    <i class="bi bi-chevron-up" style="color: #007bff; font-size:1em;"></i>
                                                </a>
                                                <a href="?sort=name_desc" class="btn btn-light btn-sm rounded-circle p-0 ms-1" style="width:1.5em; height:1.5em;" title="Sort Z-A">
                                                    <i class="bi bi-chevron-down" style="color: #007bff; font-size:1em;"></i>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="fw-bold text-center align-middle" style="font-size:1.6em; vertical-align: middle;">Description</th>
                                        <th class="fw-bold text-center align-middle" style="font-size:1.6em; vertical-align: middle;">
                                            <div class="d-flex flex-row align-items-center justify-content-center" style="gap:6px;">
                                                <span>Category</span>
                                                <a href="?sort=category_asc" class="btn btn-light btn-sm rounded-circle p-0 ms-1" style="width:1.5em; height:1.5em;" title="Sort A-Z">
                                                    <i class="bi bi-chevron-up" style="color: #007bff; font-size:1em;"></i>
                                                </a>
                                                <a href="?sort=category_desc" class="btn btn-light btn-sm rounded-circle p-0 ms-1" style="width:1.5em; height:1.5em;" title="Sort Z-A">
                                                    <i class="bi bi-chevron-down" style="color: #007bff; font-size:1em;"></i>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="fw-bold text-center align-middle" style="font-size:1.6em; min-width: 200px; vertical-align: middle;"> 
                                            <div class="d-flex flex-row align-items-center justify-content-center" style="gap:6px;">
                                                <span>Due Date</span>
                                                <a href="?sort=date_asc" class="btn btn-light btn-sm rounded-circle p-0 ms-1" style="width:1.5em; height:1.5em;" title="Sort A-Z">
                                                    <i class="bi bi-chevron-up" style="color: #007bff; font-size:1em;"></i>
                                                </a>
                                                <a href="?sort=date_desc" class="btn btn-light btn-sm rounded-circle p-0 ms-1" style="width:1.5em; height:1.5em;" title="Sort Z-A">
                                                    <i class="bi bi-chevron-down" style="color: #007bff; font-size:1em;"></i>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="fw-bold text-center align-middle" style="font-size:1.6em; vertical-align: middle;">Status</th>
                                        <th class="fw-bold text-center align-middle" style="font-size:1.6em; min-width: 140px; vertical-align: middle;">Assign To</th>
                                        <th class="fw-bold w-25 text-center align-middle" style="font-size:1.6em; vertical-align: middle;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach(Todo task in Model)
                                    {
                                        string rowClass = "";
                                        if (task.Status.statusId.ToLower() == "completed")
                                        {
                                            rowClass = "table-success"; // yeşil
                                        }
                                        else if (task.Status.statusId.ToLower() == "pending")
                                        {
                                            if (task.dueDate.HasValue && task.dueDate.Value < DateTime.Now)
                                            {
                                                rowClass = "table-danger"; // kırmızı
                                            }
                                            else if (task.dueDate.HasValue && task.dueDate.Value >= DateTime.Now)
                                            {
                                                rowClass = "table-warning"; // sarı
                                            }
                                        }
                                        <tr class="@rowClass">
                                            <td>@task.todName</td>
                                            <td>@task.todDescription</td>
                                            <td>@task.Category.categoryName</td>
                                            <td>@task.dueDate?.ToString("MM/dd/yyyy")</td>
                                            <td>
                                                @task.Status.statusName
                                                @if (task.dueDate.HasValue)
                                                {
                                                    var daysLeft = (task.dueDate.Value.Date - DateTime.Now.Date).TotalDays;
                                                    if (daysLeft >= 0 && daysLeft < 5)
                                                    {
                                                        <span style="color:red; font-weight:bold;"> (Kalan: @daysLeft gün)</span>
                                                    }
                                                    else if (daysLeft >= 5 && daysLeft <= 14)
                                                    {
                                                        <span> (Kalan: @daysLeft gün)</span>
                                                    }
                                                }
                                            </td>
                                            <td>
                                                @if (task.User != null)
                                                {
                                                    <span>@task.User.userName (@task.User.userMail)</span>
                                                }
                                                else
                                                {
                                                    <span>Atanmadı</span>
                                                }
                                            </td>
                                            <td>
                                                @*<form asp-action="DeleteTask" method="post" asp-route-id="@ViewBag.Filters.FilterString" style="display:inline;">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" name="todId" value="@task.todId" title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form> *@
                                                @if(task.Status.statusId == "pending")
                                                {
                                                    <form asp-action="MarkComplete" method="post" asp-route-id="@ViewBag.Filters.FilterString" style="display:inline;">
                                                        <button type="submit" class="btn btn-info btn-sm" name="todId" value="@task.todId">Mark as Completed</button>
                                                    </form>
                                                }
                                                else if(task.Status.statusId == "completed")
                                                {
                                                    <form asp-action="Unmark" method="post" asp-route-id="@ViewBag.Filters.FilterString" style="display:inline;">
                                                        <button type="submit" class="btn btn-warning btn-sm" name="todId" value="@task.todId">Unmark</button>
                                                    </form>
                                                }    
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </form>
                    </div>
                </div>
            }
        </div>
    }
</div>

